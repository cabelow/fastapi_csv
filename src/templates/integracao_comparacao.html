{% macro status_badge(status) %}
{% if status.startswith('aprovado') or status == 'exato' %}
<span class="status ok">{{ status }}</span>
{% elif status.startswith('reprovado') or status == 'dados inv√°lidos' %}
<span class="status erro">{{ status }}</span>
{% elif status == 'campo vazio' %}
<span class="status warn">{{ status }}</span>
{% else %}
<span class="status warn">{{ status }}</span>
{% endif %}
{% endmacro %}

<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <title>Compara√ß√£o BTP x AYZ</title>

    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f4f6f8;
            margin: 0;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: auto;
            background: #fff;
            padding: 25px;
            border-radius: 10px;
        }

        h1 {
            text-align: center;
        }

        h2 {
            margin-top: 40px;
            border-bottom: 2px solid #5563DE;
            padding-bottom: 5px;
        }

        ul {
            list-style: none;
            padding: 0;
        }

        .ok {
            color: #2e7d32;
            font-weight: bold;
        }

        .erro {
            color: #c62828;
            font-weight: bold;
        }

        .warn {
            color: #ef6c00;
            font-weight: bold;
        }

        .status {
            font-weight: bold;
            text-transform: uppercase;
            font-size: 12px;
        }

        .status.ok {
            color: #2e7d32;
        }

        .status.erro {
            color: #c62828;
        }

        .status.warn {
            color: #ef6c00;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 8px;
        }

        th {
            background: #5563DE;
            color: white;
        }

        tr:nth-child(even) {
            background: #fafafa;
        }


        .linha-vazia td {
            background: #fffaf0;
        }

        .linha-invalida td {
            background: #fff5f5;
        }

        .cpf-header {
            margin-top: 25px;
            padding: 10px;
            border-left: 4px solid #5563DE;
            background: #fafafa;
            font-weight: bold;
        }

        a.download-btn {
            display: inline-block;
            padding: 10px 16px;
            margin-right: 10px;
            border-radius: 8px;
            text-decoration: none;
            color: #fff;
            font-weight: bold;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        a.download-btn.pdf {
            background: #4CAF50;
        }

        a.download-btn.csv {
            background: #2196F3;
        }

        a.download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.2);
        }

        .cpf-erro {
            border-left-color: #c62828;
            color: #c62828;
        }

        .critical-alert {
            border: 2px solid #c62828;
            padding: 15px;
            border-radius: 8px;
            background: #fffafa;
            margin: 20px 0;
        }

        .cpf-warn {
            border-left-color: #ef6c00;
            color: #ef6c00;
        }

        .cpf-flag {
            margin-left: 10px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .cpf-flag.erro {
            color: #c62828;
        }

        .cpf-flag.warn {
            color: #ef6c00;
        }
    </style>
</head>

<body>
    <div class="container">

        <h1><i class="fa-solid fa-scale-balanced"></i> Integra√ß√£o BTP √ó AYZ</h1>

        <h2>üìä Resumo</h2>
        <ul>
            <li>Total BTP: {{ resultado.resumo.total_btp }}</li>
            <li>Total AYZ: {{ resultado.resumo.total_ayz }}</li>
            <li class="ok">Matches exatos: {{ resultado.resumo.matches_exatos }}</li>
            <li class="warn">Matches sem√¢nticos: {{ resultado.resumo.matches_semanticos }}</li>
            <li class="erro">Diverg√™ncias reais: {{ resultado.resumo.divergencias_reais }}</li>
            <li class="erro">Alertas cr√≠ticos: {{ resultado.resumo.alertas_criticos }}</li>
        </ul>

        <h3>Download</h3>
        <div style="margin-bottom: 20px;">
            <a class="download-btn pdf" target="_blank"
                href="/integracao/comparar/download/pdf?ia_name={{ ia_name }}&ia_depara={{ ia_depara }}">
                üìÑ Baixar PDF
            </a>
            <a class="download-btn csv" target="_blank"
                href="/integracao/comparar/download/csv?ia_name={{ ia_name }}&ia_depara={{ ia_depara }}">
                üìä Baixar CSV
            </a>
        </div>


        <h2>‚úÖ Matches exatos</h2>
        <table>
            <tr>
                <th>CPF</th>
                <th>Origem - AYZ ID</th>
                <th>Detino - BTP ID</th>
            </tr>
            {% for item in resultado.matches_exatos %}
            <tr>
                <td>{{ item.cpf }}</td>
                <td>{{ item.ayz_id }}</td>
                <td>{{ item.btp_id }}</td>
            </tr>
            {% else %}
            <tr>
                <td colspan="3">Nenhum match exato</td>
            </tr>
            {% endfor %}
        </table>

        <br /><br /><br /><br />

        <h2>üß† Matches sem√¢nticos (IA)</h2>
        {% for item in resultado.matches_semanticos %}
        <div class="cpf-header">
            CPF {{ item.cpf }} | BTP {{ item.btp_id }} | AYZ {{ item.ayz_id }}
        </div>

        <table>
            <tr>
                <th>Campo</th>
                <th>Origem - AYZ ID</th>
                <th>Detino - BTP ID</th>
                <th>Status</th>
                <th>Score</th>
            </tr>
            {% for campo, valores in item.divergencias.items() %}
            <tr
                class="{% if valores.status == 'campo vazio' %}linha-vazia{% elif valores.status == 'dados inv√°lidos' %}linha-invalida{% endif %}">
                <td>{{ campo }}</td>
                <td>{{ valores.ayz if valores.ayz else '‚Äî' }}</td>
                <td>{{ valores.btp if valores.btp else '‚Äî' }}</td>
                <td>{{ status_badge(valores.status) }}</td>
                <td>{{ "%.3f"|format(valores.score) }}</td>
            </tr>
            {% endfor %}
        </table>
        {% else %}
        <p>Nenhum match sem√¢ntico encontrado.</p>
        {% endfor %}

        <br /><br /><br /><br />

        <h2>‚ö†Ô∏è Diverg√™ncias reais</h2>
        {% for item in resultado.divergencias_reais %}

        <div class="cpf-header
            {% if item.cpf_duplicado %}
                cpf-erro
            {% elif item.cpf_mal_formado %}
                cpf-warn
            {% endif %}
        ">
            CPF {{ item.cpf }}

            {% if item.cpf_duplicado %}
            <span class="cpf-flag erro">CPF DUPLICADO</span>
            {% elif item.cpf_mal_formado %}
            <span class="cpf-flag warn">CPF MAL FORMADO</span>
            {% endif %}
        </div>

        <table>
            <tr>
                <th>Campo</th>
                <th>BTP</th>
                <th>AYZ</th>
                <th>Status</th>
                <th>Score</th>
            </tr>
            {% for campo, valores in item.divergencias.items() %}
            <tr
                class="{% if valores.status == 'campo vazio' %}linha-vazia{% elif valores.status == 'dados inv√°lidos' %}linha-invalida{% endif %}">
                <td>{{ campo }}</td>
                <td>{{ valores.btp if valores.btp else '‚Äî' }}</td>
                <td>{{ valores.ayz if valores.ayz else '‚Äî' }}</td>
                <td>{{ status_badge(valores.status) }}</td>
                <td>{{ "%.3f"|format(valores.score) }}</td>
            </tr>
            {% endfor %}
        </table>
        {% endfor %}

        <br /><br /><br /><br />

        {% if resultado.alertas_criticos %}
        <div class="critical-alert">
            <h2>‚ùå Alertas Cr√≠ticos</h2>
            <table>
                <tr>
                    <th>CPF</th>
                    <th>Motivo</th>
                    <th>Origem</th>
                </tr>
                {% for alerta in resultado.alertas_criticos %}
                <tr>
                    <td class="cpf-erro">{{ alerta.cpf }}</td>
                    <td>{{ status_badge(alerta.motivo) }}</td>
                    <td>{{ alerta.origem }}</td>
                </tr>
                {% endfor %}
            </table>
        </div>
        {% endif %}

    </div>
</body>

</html>